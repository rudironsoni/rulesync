name: PR Auto AI Review

on:
  pull_request:
    types: [opened, reopened, ready_for_review, synchronize]

concurrency:
  group: pr-auto-ai-review-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  review:
    if: github.event.pull_request.draft == false && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0

      - name: Minimize old bot review comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          minimized=0
          failed=0
          while IFS= read -r node_id; do
            [ -z "${node_id}" ] && continue
            if gh api graphql \
              -f query='mutation($id:ID!){ minimizeComment(input:{subjectId:$id,classifier:OUTDATED}) { minimizedComment { isMinimized minimizedReason } } }' \
              -f id="${node_id}" >/dev/null; then
              minimized=$((minimized + 1))
            else
              failed=$((failed + 1))
            fi
          done < <(
            gh api --paginate "repos/${OWNER}/${REPO}/pulls/${PR_NUMBER}/comments" \
              -H "Accept: application/vnd.github+json" \
              --jq '.[] | select(.user.login == "opencode-agent" or .user.login == "opencode-agent[bot]" or .user.login == "github-actions" or .user.login == "github-actions[bot]") | .node_id'
          )
          echo "Review comment minimize result: minimized=${minimized}, failed=${failed}"

      - name: Setup mise
        uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3.6.1
        with:
          experimental: true

      - name: Install dependencies
        run: pnpm install --ignore-scripts

      - name: Generate project artifacts
        run: pnpm generate

      - name: Configure git identity
        run: |
          git config user.name "dyoshikawa"
          git config user.email "dyoshikawa1993@gmail.com"

      - name: Ensure clean working tree
        run: |
          git reset --hard
          git clean -fd

      - name: Run OpenCode AI review
        uses: anomalyco/opencode/github@4d187af9d20b04e4fbd77ad04eaaea241b8e25bf # v1.1.2
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          model: openrouter/deepseek/deepseek-v3.2
          use_github_token: "true"
          share: false
          prompt: |
            You are working on a GitHub pull request. Read the following environment variables to get context:
            - PR_NUMBER: The pull request number

            Follow these steps:
            - Call code-reviewer subagent to review the code changes in the PR.
            - Call security-reviewer subagent to review the security issues in the PR.

            Integrate and report the execution results from each subagent. Additionally, please output PR number in the result so that the user can easily find the PR.

      - name: Minimize old github-actions bot issue comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          minimized=0
          failed=0
          while IFS= read -r node_id; do
            [ -z "${node_id}" ] && continue
            if gh api graphql \
              -f query='mutation($id:ID!){ minimizeComment(input:{subjectId:$id,classifier:OUTDATED}) { minimizedComment { isMinimized minimizedReason } } }' \
              -f id="${node_id}" >/dev/null; then
              minimized=$((minimized + 1))
            else
              failed=$((failed + 1))
            fi
          done < <(
            gh api --paginate "repos/${OWNER}/${REPO}/issues/${PR_NUMBER}/comments" \
              -H "Accept: application/vnd.github+json" \
              --jq '.[] | select(.user.login == "github-actions[bot]" or .user.login == "opencode-agent[bot]") | .node_id'
          )
          echo "Minimize result: minimized=${minimized}, failed=${failed}"
